name: governance v4 auto

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: governance-v4-auto
  cancel-in-progress: true

permissions:
  contents: write
  actions: read
  packages: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run governance
        run: |
          python scripts/governance_v4_auto.py

      - name: Sanitize filenames (Windows-safe)
        shell: bash
        run: |
          python - <<PY
          import subprocess
          from pathlib import Path
          def out(*a):
              return subprocess.check_output(a).decode("utf-8","replace")
          files = out("git","ls-files","-z").split("\0")
          bad = [f for f in files if f and ":" in f]
          bad.sort(key=lambda s: s.count("/"), reverse=True)
          if bad:
              print(f"Sanitizing {len(bad)} paths containing :")
          for old in bad:
              new = old.replace(":", "-")
              Path(new).parent.mkdir(parents=True, exist_ok=True)
              subprocess.check_call(["git","mv","-f", old, new])
          PY

      - name: Commit state if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add STATE || true
          git diff --cached --quiet || git commit -m "auto: governance v4 state update"
          git push

      - name: Aggregate Unified State
        run: python scripts/aggregate_state.py
  
