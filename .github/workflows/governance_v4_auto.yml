name: Governance v4 (AUTO)

on:
  workflow_dispatch:
    inputs:
      top_n:
        description: "How many top repos to process"
        required: false
        default: "20"
  schedule:
    - cron: "17 */6 * * *"

permissions:
  contents: write

concurrency:
  group: governance-v4-auto
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OWNER: yanivmizrachiy
      TOP_N: ${{ inputs.top_n || 20 }}
      GH_TOKEN: ${{ secrets.GH_PAT }}
    steps:
      - name: Checkout system-core
        uses: actions/checkout@v4

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Sanity: gh + auth
        run: |
          gh --version
          gh auth status || true
          test -n "${GH_TOKEN}" || (echo "❌ Missing secret GH_PAT" && exit 2)

      - name: Run governance v4 batch
        run: |
          python scripts/governance_v4_auto.py "${OWNER}" "${TOP_N}"

      - name: Commit & Push (if changed)
        run: |
          git status -sb
          git add -A
          if git diff --cached --quiet; then
            echo "ℹ️ nothing to commit"
            exit 0
          fi
          git config user.name "yaniv-bot"
          git config user.email "yaniv-bot@users.noreply.github.com"
          git commit -m "governance: v4 auto $(date -Iseconds)"
          git push
