name: governance v4 auto

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

on:
  workflow_dispatch:
    inputs:
      top_n:
        description: "How many repos to list in dashboard (top)"
        required: false
        default: "20"

permissions:
  contents: write
  actions: read
  metadata: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OWNER: ${{ github.repository_owner }}
      TOP_N: ${{ inputs.top_n || 20 }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    steps:
      - name: Checkout system-core
        uses: actions/checkout@v4
        
      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Run governance v4 auto
        run: |
          python scripts/governance_v4_auto.py "${OWNER}" "${TOP_N}"
          
      - name: Commit & Push (if changed)
        run: |
          git status -sb
          git add -A
          if git diff --cached --quiet; then
            echo "ℹ️ nothing to commit"
            exit 0
          fi
          git config user.name "yaniv-bot"
          git config user.email "yaniv-bot@users.noreply.github.com"
          git commit -m "governance: v4 auto $(date -Iseconds)"
          git push
