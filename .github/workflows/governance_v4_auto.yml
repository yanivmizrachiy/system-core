name: governance v4 auto

on:
  workflow_dispatch:
    inputs:
      top_n:
        description: "How many repos to process (top risk)"
        required: false
        default: "20"
  schedule:
    - cron: "17 */6 * * *"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OWNER: yanivmizrachiy
      TOP_N: ${{ inputs.top_n || 20 }}
      GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout system-core
        uses: actions/checkout@v4

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Sanity
        run: |
          gh --version
          echo "OWNER=$OWNER TOP_N=$TOP_N"
          if [ -z "${GH_TOKEN}" ]; then
            echo "❌ Missing token (GH_PAT or GITHUB_TOKEN)"; exit 2
          fi

      - name: Sanity: whoami via GH_TOKEN
        run: |
          echo "token_present=${GH_TOKEN:+yes}${GH_TOKEN:-no}"
          python -c "import os; print(\"ENV_HAS_TOKEN=\", bool(os.environ.get(\"GH_TOKEN\")))"

      - name: Run governance v4 auto
        run: |
          python scripts/governance_v4_auto.py "${OWNER}" "${TOP_N}"

      - name: Commit & Push (if changed)
        run: |
          git status -sb
          git add -A
          if git diff --cached --quiet; then
            echo "ℹ️ nothing to commit"
            exit 0
          fi
          git config user.name  "yaniv-bot"
          git config user.email "yaniv-bot@users.noreply.github.com"
          git commit -m "governance: v4 auto $(date -Iseconds)"
          git push
